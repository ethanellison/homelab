version: "3.8"

x-common-config: &common-config
  restart: unless-stopped

services:
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    privileged: true
    network_mode: host
    volumes:
      - /opt/homeassistant/config:/config
      - /etc/localtime:/etc/localtime:ro
      - /run/dbus:/run/dbus:ro
    environment:
      TZ: America/Toronto
    restart: unless-stopped
    profiles: [local]

  pihole:
    container_name: pihole
    image: pihole/pihole:2025.11.0
    network_mode: host
    ports: []
    environment:
      TZ: America/Toronto
      FTLCONF_dns_listeningMode: single
      FTLCONF_dns_interface: eth0
      FTLCONF_dns_upstreams: "1.1.1.1;1.0.0.1"
    command: sh -c "export FTLCONF_webserver_api_password=$(cat /run/secrets/pihole_password) && /s6-init"
    restart: unless-stopped
    volumes:
      - /opt/pihole/etc-pihole:/etc/pihole
      - /opt/pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    secrets:
      - source: pihole_password
        target: pihole_password
    profiles: [local]

  actual_server_tailscale:
    image: tailscale/tailscale:latest
    container_name: actual_server_tailscale
    hostname: actual-server
    volumes:
      - /opt/actual/ts-state:/var/lib/tailscale
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_HOSTNAME=actual-server
      - TS_USERSPACE=false
      - TS_EXTRA_ARGS=--advertise-tags=tag:actual-server
    restart: unless-stopped
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - net_admin
    profiles: [local]

  actual_server:
    image: docker.io/actualbudget/actual-server:25.11.0
    container_name: actual_server
    network_mode: service:actual_server_tailscale
    environment:
      - ACTUAL_PORT=5006
    volumes:
      - /opt/actual/data:/data
    healthcheck:
      test: ['CMD-SHELL', 'node src/scripts/health-check.js']
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    profiles: [local]

  redis:
    <<: *common-config
    image: docker.io/library/redis:8
    volumes:
      - redis_data:/data
    secrets:
      - source: redis_password
        target: redis_password
    command: sh -c "redis-server --requirepass $(cat /run/secrets/redis_password)"
    profiles: [local]

  paperless:
    <<: *common-config
    image: ghcr.io/paperless-ngx/paperless-ngx:2.18.4
    depends_on:
      - redis
    volumes:
      - paperless_data:/usr/src/paperless/data
      - paperless_media:/usr/src/paperless/media
      - paperless_consume:/usr/src/paperless/consume
      - paperless_export:/usr/src/paperless/export
    environment:
      TZ: America/Toronto
      PAPERLESS_REDIS: redis://redis:6379
      PAPERLESS_SECRET_KEY_FILE: /run/secrets/paperless_secret_key
      PAPERLESS_ADMIN_PASSWORD_FILE: /run/secrets/paperless_admin_password
    secrets:
      - source: paperless_secret_key
        target: paperless_secret_key
      - source: paperless_admin_password
        target: paperless_admin_password
    profiles: [local]

  initContainer:
    image: busybox
    command: ['sh', '-c', 'chown -R 1000:1000 /home/node/.n8n']
    volumes:
      - /opt/n8n_data:/home/node/.n8n
    profiles: [vps]

  postgres:
    image: pgvector/pgvector:pg16
    restart: always
    container_name: postgres
    environment:
      - POSTGRES_DB=n8n
      - POSTGRES_USER=n8n
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
    secrets:
      - source: postgres_password
        target: postgres_password
    volumes:
      - /opt/postgres_data:/var/lib/postgresql/data
    ports:
      - 5432:5432
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U n8n -d n8n']
      interval: 30s
      timeout: 10s
      retries: 3
    profiles: [vps]

  n8n:
    image: docker.n8n.io/n8nio/n8n:1.119.1
    restart: always
    container_name: n8n
    ports:
      - 5678:5678
    depends_on:
      - initContainer
      - postgres
    volumes:
      - /opt/n8n_data:/home/node/.n8n
    environment:
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - WEBHOOK_URL=https://n8n.dzo-byzantine.ts.net
      - N8N_PROXY_HOPS=1
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD=n8n_password
      - N8N_VECTOR_STORE_ENABLED=true
      - N8N_VECTOR_STORE_TYPE=postgres
      - N8N_VECTOR_STORE_POSTGRES_HOST=postgres
      - N8N_VECTOR_STORE_POSTGRES_PORT=5432
      - N8N_VECTOR_STORE_POSTGRES_DATABASE=n8n
      - N8N_VECTOR_STORE_POSTGRES_USER=n8n
      - N8N_VECTOR_STORE_POSTGRES_PASSWORD=n8n_password
    labels:
      - tsdproxy.enable=true
      - tsdproxy.funnel=true
    secrets:
      - source: postgres_password
        target: postgres_password
    profiles: [vps]

  tsdproxy:
    image: almeidapaulopt/tsdproxy:2
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /opt/tsdproxy_data:/data
      - ../base/tsdproxy/config:/config
    ports:
      - "8080:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    secrets:
      - tsdproxy_auth
    profiles: [vps]

volumes:
  homeassistant_config:
  pihole_etc:
  pihole_dnsmasq:
  paperless_data:
  paperless_media:
  paperless_consume:
  paperless_export:
  redis_data:

secrets:
  pihole_password:
    file: ../secrets/pihole_password.txt
  postgres_password:
    file: ../secrets/postgres_password.txt
  paperless_secret_key:
    file: ../secrets/paperless_secret_key.txt
  paperless_admin_password:
    file: ../secrets/paperless_admin_password.txt
  redis_password:
    file: ../secrets/redis_password.txt
  tsdproxy_auth:
    environment: TSDPROXY_AUTH