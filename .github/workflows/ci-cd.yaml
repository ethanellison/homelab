name: CI/CD Pipeline

on:
  pull_request:
    branches: [main]
  workflow_dispatch: {}

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Validate Kubernetes manifests
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          ./kustomize version

          # Validate Kubernetes manifests
          echo "Validating infrastructure manifests..."
          ./kustomize build infrastructure/kubernetes/base

          echo "Validating application manifests..."
          # ./kustomize build applications/kubernetes/base

          # Add more validation steps as needed

      - name: Validate Docker Compose files
        run: |
          # Install yq
          sudo apt-get update && sudo apt-get install -y yq

          # Install Docker Compose V2
          DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
          mkdir -p $DOCKER_CONFIG/cli-plugins
          curl -SL https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-linux-x86_64 -o $DOCKER_CONFIG/cli-plugins/docker-compose
          chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose

          ROOT="applications/compose"

          validate_host() {
            HOST=$1
            echo "Validating $HOST environment compose files..."
            
            SERVICES=$(yq -r '.services[]' "$ROOT/environments/$HOST/services.yaml")
            
            FILES=""
            for S in $SERVICES; do
              FILES="$FILES -f $ROOT/base/$S/compose.yaml"
            done
            
            FILES="$FILES -f $ROOT/environments/$HOST/docker-compose.yaml"
            
            docker compose $FILES config
          }

          validate_host local
          validate_host vps

  deploy:
    needs: validate
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    concurrency: production_environment

    steps:
      - uses: actions/checkout@v6

      - name: Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
          ping: srv715735.dzo-byzantine.ts.net
      - name: Setup SSH_PRIVATE_KEY
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "srv715735.dzo-byzantine.ts.net" >> ~/.ssh/known_hosts

      - name: Install yq
        run: |
          sudo apt-get update && sudo apt-get install -y yq

      - name: Deploy to VPS
        env:
          HOST: srv715735.dzo-byzantine.ts.net
          USERNAME: root
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          HOST_ENV="vps"
          ROOT="applications/compose"

          # 1. Get the list of services to deploy
          SERVICES=$(yq -r '.services[]' "$ROOT/environments/$HOST_ENV/services.yaml")
          echo "Deploying services: $SERVICES"

          # 2. Use SSH and pass the services list as an environment variable to the remote shell
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=accept-new root@srv715735.dzo-byzantine.ts.net 'set -euo pipefail
            echo "âœ… Connected to host and preparing secrets"
            
            SERVICES="'"$SERVICES"'"
            TEMP_ENV_FILE="/tmp/homelab-secrets-$(date +%s%N).env"
            
            # Base CI secrets
            gpg --quiet --batch --yes --pinentry-mode loopback --passphrase "${{ secrets.GPG_PASSPHRASE }}" -d ~/.password-store/github/ci.gpg > "$TEMP_ENV_FILE"
            chmod 600 "$TEMP_ENV_FILE"  # Apply secure permissions immediately

            # Service-specific secrets
            for SERVICE in $SERVICES; do
              # We use a naming convention: ~/.password-store/homelab/vps/SERVICE_NAME.gpg
              SECRET_PATH="$HOME/.password-store/homelab/vps/${SERVICE}.gpg"
              # Check for file existence before attempting to decrypt
              if [ -f "$SECRET_PATH" ]; then
                echo "Decrypting secrets for service: ${SERVICE}"
                gpg --quiet --batch --yes --pinentry-mode loopback --passphrase "${{ secrets.GPG_PASSPHRASE }}" -d "$SECRET_PATH" >> "$TEMP_ENV_FILE"
                echo "" >> "$TEMP_ENV_FILE" # Ensure a newline after decryption
              else
                echo "No specific secret found for service: ${SERVICE} at ${SECRET_PATH}"
              fi
            done
            
            cd /opt/homelab
            git pull origin main
            chmod +x scripts/**/*.sh
            ./scripts/setup/init-dev-environment.sh docker

            # Deploy using the securely decrypted environment file
            HOMELAB_ENV_FILE="$TEMP_ENV_FILE" ./scripts/deploy/deploy-compose.sh vps up

            # Securely remove the temporary environment file
            rm -f "$TEMP_ENV_FILE"'
